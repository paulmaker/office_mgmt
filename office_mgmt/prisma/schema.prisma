generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model TenantAccount {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  isActive  Boolean  @default(true)
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  entities  Entity[]
}

model Entity {
  id               String            @id @default(cuid())
  tenantAccountId  String
  name             String
  slug             String
  isActive         Boolean           @default(true)
  settings         Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  bankTransactions BankTransaction[]
  cisReturns       CISReturn[]
  clients          Client[]
  assets           CompanyAsset[]
  employees        Employee[]
  tenantAccount    TenantAccount     @relation(fields: [tenantAccountId], references: [id], onDelete: Cascade)
  invoices         Invoice[]
  invoiceCodes     InvoiceCode[]
  jobs             Job[]
  jobPrices        JobPrice[]
  quickLinks       QuickLink[]
  subcontractors   Subcontractor[]
  suppliers        Supplier[]
  timesheets       Timesheet[]
  users            User[]
  vatReturns       VATReturn[]

  @@unique([tenantAccountId, slug])
  @@index([tenantAccountId])
}

model Permission {
  id              String           @id @default(cuid())
  resource        String
  action          String
  module          String?
  description     String?
  rolePermissions RolePermission[]

  @@unique([resource, action, module])
  @@index([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  role         Role
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
}

model User {
  id               String        @id @default(cuid())
  name             String?
  email            String        @unique
  emailVerified    DateTime?
  image            String?
  entityId         String
  role             Role          @default(ENTITY_USER)
  isActive         Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  password         String?
  resetToken       String?       @unique
  resetTokenExpiry DateTime?
  authAccounts     AuthAccount[]
  sessions         Session[]
  entity           Entity        @relation(fields: [entityId], references: [id])

  @@index([entityId])
  @@index([email])
}

model AuthAccount {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Client {
  id             String        @id @default(cuid())
  entityId       String
  name           String
  companyName    String?
  email          String
  phone          String?
  address        String?
  billingAddress String?
  vatNumber      String?
  vatRegistered  Boolean       @default(false)
  cisRegistered  Boolean       @default(false)
  paymentTerms   Int           @default(30)
  ratesConfig    Json?
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  referenceCode  String?
  entity         Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  salesInvoices  Invoice[]     @relation("ClientSalesInvoices")
  invoiceCodes   InvoiceCode[]
  jobs           Job[]
  jobPrices      JobPrice[]

  @@index([entityId])
}

model Subcontractor {
  id                    String             @id @default(cuid())
  entityId              String
  name                  String
  email                 String
  phone                 String?
  address               String?
  niNumber              String?
  utr                   String?
  cisVerificationNumber String?
  cisStatus             CISStatus          @default(NOT_VERIFIED)
  paymentType           PaymentType        @default(CIS)
  bankDetails           Json?
  car                   String?
  notes                 String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  purchaseInvoices      Invoice[]          @relation("SubcontractorPurchaseInvoices")
  entity                Entity             @relation(fields: [entityId], references: [id], onDelete: Cascade)
  timesheets            Timesheet[]
  jobs                  JobSubcontractor[]

  @@unique([entityId, email])
  @@index([entityId])
}

model Invoice {
  id                  String            @id @default(cuid())
  entityId            String
  invoiceNumber       String
  type                InvoiceType
  clientId            String?
  subcontractorId     String?
  date                DateTime          @default(now())
  dueDate             DateTime
  subtotal            Float
  vatAmount           Float             @default(0)
  vatRate             Float             @default(20)
  cisDeduction        Float             @default(0)
  cisRate             Float             @default(0)
  reverseCharge       Boolean           @default(false)
  total               Float
  status              InvoiceStatus     @default(DRAFT)
  paymentDate         DateTime?
  paymentMethod       String?
  lineItems           Json
  notes               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  supplierId          String?
  sentDate            DateTime?
  receivedDate        DateTime?
  jobId               String?
  discountAmount      Float             @default(0)
  discountPercentage  Float             @default(0)
  discountType        String?
  paidAmount          Float             @default(0)
  outstandingAmount   Float
  paymentReference    String?
  purchaseOrderNumber String?
  description         String?
  documentUrl         String?
  bankTransactions    BankTransaction[]
  client              Client?           @relation("ClientSalesInvoices", fields: [clientId], references: [id])
  entity              Entity            @relation(fields: [entityId], references: [id], onDelete: Cascade)
  job                 Job?              @relation(fields: [jobId], references: [id])
  subcontractor       Subcontractor?    @relation("SubcontractorPurchaseInvoices", fields: [subcontractorId], references: [id])
  supplier            Supplier?         @relation("SupplierPurchaseInvoices", fields: [supplierId], references: [id])

  @@unique([entityId, invoiceNumber])
  @@index([entityId])
  @@index([status])
  @@index([dueDate])
}

model Timesheet {
  id                  String          @id @default(cuid())
  entityId            String
  subcontractorId     String
  periodStart         DateTime
  periodEnd           DateTime
  hoursWorked         Float
  rate                Float
  grossAmount         Float
  cisDeduction        Float           @default(0)
  netAmount           Float
  status              TimesheetStatus @default(SUBMITTED)
  submittedVia        String?
  approvedBy          String?
  approvedAt          DateTime?
  processedAt         DateTime?
  paidAt              DateTime?
  notes               String?
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  expenses            Float           @default(0)
  receiptsReceived    Boolean         @default(false)
  submittedDate       DateTime?
  additionalHours     Float           @default(0)
  additionalHoursRate Float           @default(0)
  entity              Entity          @relation(fields: [entityId], references: [id], onDelete: Cascade)
  subcontractor       Subcontractor   @relation(fields: [subcontractorId], references: [id])

  @@index([entityId])
}

model BankTransaction {
  id                 String          @id @default(cuid())
  entityId           String
  date               DateTime
  description        String
  amount             Float
  type               TransactionType
  category           String?
  reconciled         Boolean         @default(false)
  invoiceId          String?
  notes              String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  reconciliationDate DateTime?
  reconciledBy       String?
  linkedTimesheetId  String?
  documentUrl        String?
  entity             Entity          @relation(fields: [entityId], references: [id], onDelete: Cascade)
  invoice            Invoice?        @relation(fields: [invoiceId], references: [id])

  @@index([entityId])
}

model CompanyAsset {
  id                 String    @id @default(cuid())
  entityId           String
  type               AssetType
  name               String
  registrationNumber String?
  motDueDate         DateTime?
  taxDueDate         DateTime?
  insuranceDueDate   DateTime?
  serviceDueDate     DateTime?
  remindersEnabled   Boolean   @default(true)
  notes              String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  leaseExpiryDate    DateTime?
  merseyFlow         Boolean   @default(true)
  companyCar         Boolean   @default(true)
  entity             Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
}

model QuickLink {
  id           String   @id @default(cuid())
  entityId     String
  name         String
  url          String
  category     String
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  entity       Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
}

model VATReturn {
  id            String    @id @default(cuid())
  entityId      String
  periodStart   DateTime
  periodEnd     DateTime
  salesVAT      Float
  purchaseVAT   Float
  netVAT        Float
  submittedDate DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  entity        Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
}

model CISReturn {
  id               String    @id @default(cuid())
  entityId         String
  month            Int
  year             Int
  totalDeductions  Float
  contractorsCount Int
  submittedDate    DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  entity           Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
}

model Employee {
  id         String        @id @default(cuid())
  entityId   String
  name       String
  email      String?
  phone      String?
  employeeId String?
  notes      String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  car        String?
  entity     Entity        @relation(fields: [entityId], references: [id], onDelete: Cascade)
  jobs       JobEmployee[]

  @@unique([entityId, email])
  @@unique([entityId, employeeId])
  @@index([entityId])
}

model Job {
  id                String             @id @default(cuid())
  entityId          String
  jobNumber         String
  clientId          String
  jobDescription    String
  dateWorkCommenced DateTime
  price             Float
  status            JobStatus          @default(PENDING)
  invoicePaid       Boolean            @default(false)
  invoiceId         String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  balance           Float              @default(0)
  lastBalanceUpdate DateTime?
  invoices          Invoice[]
  client            Client             @relation(fields: [clientId], references: [id])
  entity            Entity             @relation(fields: [entityId], references: [id], onDelete: Cascade)
  employees         JobEmployee[]
  subcontractors    JobSubcontractor[]
  lineItems         JobLineItem[]

  @@unique([entityId, jobNumber])
  @@index([entityId])
}

model JobEmployee {
  id         String   @id @default(cuid())
  jobId      String
  employeeId String
  createdAt  DateTime @default(now())
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, employeeId])
  @@index([jobId])
  @@index([employeeId])
}

model JobSubcontractor {
  id              String        @id @default(cuid())
  jobId           String
  subcontractorId String
  createdAt       DateTime      @default(now())
  subcontractor   Subcontractor @relation(fields: [subcontractorId], references: [id], onDelete: Cascade)
  job             Job           @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([jobId, subcontractorId])
  @@index([jobId])
  @@index([subcontractorId])
}

model JobLineItem {
  id          String   @id @default(cuid())
  jobId       String
  description String
  amount      Float
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
}

model InvoiceCode {
  id         String   @id @default(cuid())
  entityId   String
  clientId   String
  lastNumber Int      @default(0)
  prefix     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  entity     Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([entityId, clientId])
  @@index([entityId])
  @@index([clientId])
}

model Supplier {
  id               String    @id @default(cuid())
  entityId         String
  name             String
  companyName      String?
  email            String?
  phone            String?
  address          String?
  vatNumber        String?
  vatRegistered    Boolean   @default(false)
  paymentTerms     Int       @default(30)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  accountNumber    String?
  purchaseInvoices Invoice[] @relation("SupplierPurchaseInvoices")
  entity           Entity    @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([entityId])
}

model JobPrice {
  id          String   @id @default(cuid())
  entityId    String
  clientId    String
  jobType     String
  description String
  price       Float
  isActive    Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  entity      Entity   @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@unique([entityId, clientId, jobType])
  @@index([entityId])
  @@index([clientId])
}

enum Role {
  PLATFORM_ADMIN
  ACCOUNT_ADMIN
  ENTITY_ADMIN
  ENTITY_USER
}

enum InvoiceType {
  SALES
  PURCHASE
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum CISStatus {
  VERIFIED_GROSS
  VERIFIED_NET
  NOT_VERIFIED
}

enum PaymentType {
  CIS
  NON_CIS
}

enum TimesheetStatus {
  SUBMITTED
  APPROVED
  REJECTED
  PROCESSED
  PAID
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum AssetType {
  VEHICLE
  EQUIPMENT
  OTHER
}

enum JobStatus {
  PENDING
  IN_PROGRESS
  COMPLETE
}
